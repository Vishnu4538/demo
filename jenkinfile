
#Devosecops pipeline using Snyk tool.

pipeline { 
agent {label 'agent'}
        

    stages{
        stage('Unit testing'){
            
            steps {
                  echo "pulling the github repo"
                  git url: 'github repo', branch: 'main'
                  echo "Unit testing"
                  sh 'npm install'
                  sh 'npm audit fix --force || true'
                  sh 'npm run test'

                
            }
        }
     stage('Scanning the code'){
         
         steps{
              echo "scanning the code ..."
              snykSecurity(
                    snykInstallation: 'SnykCLI',       // Name of Snyk CLI tool in Jenkins
                    snykTokenId: 'token',     // Jenkins credential ID for your API token
                    projectName: 'devsecops-demo',     // Optional: name in Snyk dashboard      // Manifest file to scan
                    monitorProjectOnBuild: true,       // Upload results to Snyk dashboard
                    failOnIssues: true // Fail build if vulnerabilities foun
                )
            }
          }
          
          stage('static code analysis'){
              steps{
                    withCredentials([string(credentialsId: 'snkyid', variable: 'token')]) {
                    sh ' snyk auth $token'
                    sh 'snyk code test'
                    sh 'snyk code montior'
                }  
              }
          }
      stage("Building the image"){
          steps{
                 withCredentials([usernamePassword(credentialsId: 'docker', usernameVariable: 'DOCKER_USER', passwordVariable: 'DOCKER_PASS')]) {
                 sh 'echo "${DOCKER_PASS}" | docker login -u "${DOCKER_USER}" --password-stdin'
                 sh 'docker build -t DOCKER_USER/devsecops:${BUILD_NUMBER} .'
                   }
             }
         }
        stage("Scanning the image"){
            steps{
                withCredentials([string(credentialsId: 'snkyid', variable: 'token')]) {
                sh ' snyk auth $token'
                sh 'snyk container test DOCKER_USER/devsecops:${BUILD_NUMBER} || true'
                sh 'snyk container monitor DOCKER_USER/devsecops:${BUILD_NUMBER}'

                }
                sh 'docker push DOCKER_USER/devsecops:${BUILD_NUMBER}'
              }
         }
       stage('Changing the image and updateing the manifest file'){
           steps {
                    git url: 'github repo', branch: 'main'
                    echo "changing the image"
                    sh ' python3 image_update.py ${BUILD_NUMBER}'
                     withCredentials([gitUsernamePassword(credentialsId: 'git', gitToolName: 'Default')]) {
                     sh '''
                       git config user.name "USERNAME"
                      git config user.email "EMAIL"
                      git add deployment.yml
                      git commit -m "Update image tag to build ${BUILD_NUMBER}"
                      git push origin main
                    '''
                     }
                  }
              } 
        
    }
      
}
